#!/bin/bash
echo "#### Iniciado user data ####"


cd /var/www/magento2
rm /var/www/magento2/app/etc/env.php

echo "#### Novo RDS endpoint: ${rds-endpoint}"

# sudo -u www-data bin/magento setup:install \
#   --base-url=http://brunoferreira86dev.com \
#   --db-host=terraform-20240711121732038900000001.c7otnxhdeoih.us-east-1.rds.amazonaws.com \
#   --db-name=magentodb \
#   --db-user=magentoadmin \
#   --db-password=pass123456789 \
#   --admin-firstname=bruno \
#   --admin-lastname=ferreira \
#   --admin-email=brunoferreira86dev@gmail.com \
#   --admin-user=magentouser \
#   --admin-password=pass12345678 \
#   --backend-frontname=adminlkj987 \
#   --language=pt_BR \
#   --currency=BRL \
#   --timezone=America/Sao_Paulo \
#   --use-rewrites=1 \
#   --search-engine=opensearch \
#   --opensearch-host=localhost \
#   --opensearch-port=9200 \
#   --opensearch-index-prefix=magento2 \
#   --opensearch-timeout=15 2>&1 | sudo -u www-data tee magento_update2_output.log

sudo -u www-data bin/magento setup:install \
  --base-url=${my-domain} \
  --db-host=${rds-endpoint} \
  --db-name=magentodb \
  --db-user=magentoadmin \
  --db-password=pass123456789 \
  --admin-firstname=bruno \
  --admin-lastname=ferreira \
  --admin-email=${admin-email} \
  --admin-user=magentouser \
  --admin-password=pass12345678 \
  --backend-frontname=adminlkj987 \
  --language=pt_BR \
  --currency=BRL \
  --timezone=America/Sao_Paulo \
  --use-rewrites=1 \
  --search-engine=opensearch \
  --opensearch-host=localhost \
  --opensearch-port=9200 \
  --opensearch-index-prefix=magento2 \
  --opensearch-timeout=15 | sudo -u www-data tee magento_update2_output.log

# sudo -u www-data bin/magento -q setup:config:set \
#   --db-host=${rds-endpoint} \
#   2>&1 | sudo -u www-data tee magento_update_output.log

# sudo -u www-data bin/magento -q setup:config:set \
#   --db-host=terraform-20240711121732038900000001.c7otnxhdeoih.us-east-1.rds.amazonaws.com \
#   2>&1 | sudo -u www-data tee magento_update_output.log

# sudo -u www-data bin/magento -q setup:config:set \
#   --db-host=${rds-endpoint} \
#   2>&1 | sudo -u www-data tee magento_update_output.log

sudo -u www-data bash -c 'echo $(cat magento_install_output.log |
  grep "\[SUCCESS\]: Magento Admin URI:" |
  awk -F": " "{print \$3}" | sed "s#^/##") > update_admin_url_output.txt'

systemctl daemon-reload
systemctl restart nginx
sudo -u www-data bin/magento cache:flush

# Informa fim do user data para autorizar Terraform a prosseguir instalação.
echo "### Finalizado user data ###"
touch /tmp/userdata_finished